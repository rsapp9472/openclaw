#!/bin/sh
set -e

# Default values - non-root compatible paths
TS_SOCKS_PORT=${TS_SOCKS_PORT:-1055}
VPS_TAILSCALE_IP=${VPS_TAILSCALE_IP:-100.82.227.84}
VPS_SSH_USER=${VPS_SSH_USER:-root}
SSH_DIR="/tmp/.ssh"
SSH_KEY_PATH="${SSH_DIR}/vps_key"
TAILSCALE_SOCKET_DIR="/tmp/tailscale"
TAILSCALE_SOCKET="${TAILSCALE_SOCKET_DIR}/tailscaled.sock"

# Check if SSH key exists
if [ ! -f "$SSH_KEY_PATH" ]; then
    echo "Error: SSH key not found at $SSH_KEY_PATH"
    echo "Make sure VPS_SSH_KEY_B64 environment variable is set"
    exit 1
fi

# Check if Tailscale socket exists
if [ ! -S "$TAILSCALE_SOCKET" ]; then
    echo "Error: Tailscale socket not found at $TAILSCALE_SOCKET"
    echo "Make sure Tailscale is running with --socket=$TAILSCALE_SOCKET"
    exit 1
fi

# Execute SSH with direct arguments
if [ $# -eq 0 ]; then
    echo "Connecting to VPS via Tailscale..."
    exec ssh \
        -o "ProxyCommand=nc -X 5 -x 127.0.0.1:${TS_SOCKS_PORT} %h %p" \
        -o ConnectTimeout=30 \
        -o ServerAliveInterval=60 \
        -o ServerAliveCountMax=3 \
        -o StrictHostKeyChecking=accept-new \
        -o UserKnownHostsFile=/dev/null \
        -F "$SSH_DIR/config" \
        -i "$SSH_KEY_PATH" \
        "$VPS_SSH_USER@$VPS_TAILSCALE_IP"
else
    echo "Executing remote command on VPS via Tailscale..."
    exec ssh \
        -o "ProxyCommand=nc -X 5 -x 127.0.0.1:${TS_SOCKS_PORT} %h %p" \
        -o ConnectTimeout=30 \
        -o ServerAliveInterval=60 \
        -o ServerAliveCountMax=3 \
        -o StrictHostKeyChecking=accept-new \
        -o UserKnownHostsFile=/dev/null \
        -F "$SSH_DIR/config" \
        -i "$SSH_KEY_PATH" \
        "$VPS_SSH_USER@$VPS_TAILSCALE_IP" \
        "$@"
fi